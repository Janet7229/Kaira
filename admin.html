<!DOCTYPE html>
<html>
<head>
  <title>Admin Post Management</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .post { margin-top: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; display: flex; gap: 20px; align-items: center; }
    .post.hidden-post { background-color: #fff8e1; }
    img { max-width: 150px; height: auto; border-radius: 4px; }
    .post-details { flex-grow: 1; }
    .post-actions button { display: inline-block; width: auto; padding: 8px 12px; margin-left: 10px; }
    .delete-btn { background-color: #dc3545; }
    .delete-btn:hover { background-color: #c82333; }
    input, button { padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    button { background-color: #007bff; color: white; border: none; cursor: pointer; }
    #loginContainer, #mainContent { display: none; }
  </style>
</head>
<body>

<div class="container">
  <div id="loginContainer">
    <h2>Admin Login</h2>
    <input type="email" id="loginEmail" placeholder="Email" style="width: 100%;">
    <input type="password" id="loginPassword" placeholder="Password" style="width: 100%;">
    <button id="loginButton" style="width: 100%;">Login</button>
  </div>

  <div id="mainContent">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>All Posts</h2>
        <button id="logoutButton">Logout</button>
    </div>
    <div id="postsContainer">Loading...</div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  // CORRECTED: Removed refFromURL from the import
  import { getStorage, ref, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
  import { getFirestore, collection, getDocs, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
    authDomain: "shamankingdata.firebaseapp.com",
    projectId: "shamankingdata",
    storageBucket: "shamankingdata.appspot.com",
    messagingSenderId: "757444066890",
    appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const loginContainer = document.getElementById('loginContainer');
  const mainContent = document.getElementById('mainContent');
  const postsContainer = document.getElementById("postsContainer");

  onAuthStateChanged(auth, (user) => {
    if (user) {
      loginContainer.style.display = 'none';
      mainContent.style.display = 'block';
      loadPosts();
    } else {
      loginContainer.style.display = 'block';
      mainContent.style.display = 'none';
    }
  });

  async function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
      alert("Login failed. Check email and password.");
    }
  }

  async function toggleVisibility(postId, currentVisibility) {
    const postRef = doc(db, "posts", postId);
    await updateDoc(postRef, { isVisible: !currentVisibility });
    loadPosts(); // Refresh list
  }

  // ENTIRELY NEW AND IMPROVED DELETE FUNCTION
  async function deletePost(postId, postData) {
    if (!confirm("Are you sure you want to delete this post forever?")) return;

    try {
      // Step 1: Delete the image from Storage if it exists
      if (postData.imageUrl) {
        // This new logic manually extracts the file path from the URL
        const fileUrl = postData.imageUrl;
        const filePath = decodeURIComponent(fileUrl.split('/o/')[1].split('?')[0]);
        const imageRef = ref(storage, filePath);
        await deleteObject(imageRef);
      }

      // Step 2: Delete the document from Firestore
      await deleteDoc(doc(db, "posts", postId));
      
      alert("Post deleted successfully! ðŸ‘");
      loadPosts(); // Refresh the list

    } catch (error) {
      console.error("Error deleting post: ", error);
      if (error.code && error.code.startsWith('storage/')) {
        if (confirm("Could not delete the image file (it might already be gone).\n\nDo you still want to delete the post data from the database?")) {
          await deleteDoc(doc(db, "posts", postId));
          loadPosts();
        }
      } else {
        alert("An unknown error occurred while deleting. See console for details.");
      }
    }
  }

  async function loadPosts() {
    postsContainer.innerHTML = "Loading...";
    try {
      const q = query(collection(db, "posts"), orderBy("receiptNumber", "desc"));
      const snapshot = await getDocs(q);
      postsContainer.innerHTML = "";
      if (snapshot.empty) {
        postsContainer.innerHTML = "No posts found.";
        return;
      }
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const postId = docSnap.id;
        const div = document.createElement("div");
        div.className = `post ${data.isVisible ? 'visible-post' : 'hidden-post'}`;
        
        const visibilityText = data.isVisible ? "Hide" : "Show";
        const visibilityClass = data.isVisible ? "" : "approve-btn";

        div.innerHTML = `
          <img src="${data.imageUrl}" alt="uploaded image">
          <div class="post-details">
            <strong>Receipt #: ${data.receiptNumber}</strong><br>
            Status: ${data.isVisible ? 'Visible' : 'Hidden'}<br>
            <p>${data.comment || ''}</p>
          </div>
          <div class="post-actions">
            <button class="toggle-visibility-btn ${visibilityClass}">${visibilityText}</button>
            <button class="delete-btn">Delete</button>
          </div>
        `;
        div.querySelector('.toggle-visibility-btn').addEventListener('click', () => toggleVisibility(postId, data.isVisible));
        div.querySelector('.delete-btn').addEventListener('click', () => deletePost(postId, data));
        postsContainer.appendChild(div);
      });
    } catch (error) {
      console.error("Error loading posts:", error);
      postsContainer.innerHTML = "Failed to load posts.";
    }
  }
  
  document.getElementById('loginButton').addEventListener('click', handleLogin);
  document.getElementById('logoutButton').addEventListener('click', () => signOut(auth));

</script>

</body>
</html>
