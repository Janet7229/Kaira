<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registration Form</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Style for the edit modal */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen py-10">
  <!-- Main container -->
  <div class="w-full max-w-lg p-8 space-y-6 bg-white rounded-xl shadow-lg m-4">
    <!-- Header -->
    <div class="text-center">
      <h1 class="text-3xl font-bold text-gray-800">Swimmer Registration</h1>
      <p class="text-gray-500 mt-2">Add swimmers one by one, then submit all at once.</p>
    </div>
    
    <!-- Form -->
    <form id="swimmer_form" class="space-y-6">
      <div>
        <label for="full_name" class="block text-sm font-medium text-gray-700">Full Name</label>
        <input type="text" id="full_name" name="full_name" required
               placeholder="Enter swimmer's full name"
               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Gender</label>
        <div class="mt-2 flex space-x-6">
          <div class="flex items-center">
            <input id="gender_male" name="gender" type="radio" value="Male" required
                   class="h-4 w-4 text-blue-600 border-gray-300">
            <label for="gender_male" class="ml-2 text-sm text-gray-700">Male</label>
          </div>
          <div class="flex items-center">
            <input id="gender_female" name="gender" type="radio" value="Female"
                   class="h-4 w-4 text-blue-600 border-gray-300">
            <label for="gender_female" class="ml-2 text-sm text-gray-700">Female</label>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="age" class="block text-sm font-medium text-gray-700">Age</label>
            <input type="number" id="age" name="age" min="1" required
                   placeholder="Enter age"
                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
          </div>
          <div>
            <label for="age_separator" class="block text-sm font-medium text-gray-700">Age Separator</label>
            <input type="number" id="age_separator" name="age_separator" min="1" value="10"
                   placeholder="e.g., 10"
                   class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
          </div>
      </div>

      <div>
        <label for="school_club" class="block text-sm font-medium text-gray-700">School / Club</label>
        <input type="text" id="school_club" name="school_club" required
               placeholder="Enter school or club name"
               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
      </div>
      
      <div>
        <label for="num_events" class="block text-sm font-medium text-gray-700">Number of Events</label>
        <input type="number" id="num_events" name="num_events" min="0"
               placeholder="e.g., 24"
               class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
      </div>

      <div id="events_container" class="space-y-2"></div>

      <div id="add_button_container">
        <button type="button" id="add_swimmer_btn"
                class="w-full py-3 rounded-md text-white bg-blue-600 hover:bg-blue-700">
          Add Swimmer
        </button>
      </div>

      <div id="edit_buttons_container" class="hidden grid grid-cols-2 gap-4">
        <button type="button" id="update_swimmer_btn"
                class="w-full py-3 rounded-md text-white bg-yellow-500 hover:bg-yellow-600">
          Update Swimmer
        </button>
        <button type="button" id="cancel_edit_btn"
                class="w-full py-3 rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200">
          Cancel
        </button>
      </div>
    </form>
  </div>
  
  <!-- Generate Sample Data Button -->
  <div class="w-full max-w-lg mt-2">
      <button type="button" id="generate_data_btn"
              class="w-full py-2 rounded-md text-white bg-purple-500 hover:bg-purple-600">
        Generate 30 Sample Swimmers
      </button>
  </div>


  <!-- Swimmers List -->
  <div id="swimmers_list_container" class="w-full max-w-lg mt-4"></div>

  <!-- Bulk Submit -->
  <div class="w-full max-w-lg mt-6">
    <button type="button" id="bulk_submit_btn"
            class="w-full hidden py-3 rounded-md text-white bg-green-600 hover:bg-green-700">
      Bulk Submit All Swimmers
    </button>
  </div>

  <!-- NEW: Firebase Data Viewer and Filter Section -->
  <div class="w-full max-w-4xl p-8 mt-10 bg-white rounded-xl shadow-lg m-4">
      <h2 class="text-2xl font-bold text-gray-800 text-center">Registered Swimmers</h2>
      
      <!-- Filter Controls -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6">
          <input type="text" id="search_box" placeholder="Search by name..." class="px-4 py-2 border border-gray-300 rounded-md">
          <input type="text" id="filter_school" placeholder="Filter by school/club..." class="px-4 py-2 border border-gray-300 rounded-md">
          <input type="number" id="filter_age" placeholder="Filter by age..." class="px-4 py-2 border border-gray-300 rounded-md">
      </div>

      <!-- Firebase Data Display -->
      <div id="firebase_swimmers_container" class="space-y-4">
          <!-- Swimmer data will be rendered here -->
          <p class="text-center text-gray-500">Loading swimmers...</p>
      </div>
  </div>

  <!-- NEW: Edit Modal -->
  <div id="edit_modal" class="modal-backdrop hidden">
      <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg">
          <h3 class="text-xl font-bold mb-4">Edit Swimmer</h3>
          <form id="edit_form" class="space-y-4">
              <input type="hidden" id="edit_doc_id">
              <div>
                  <label for="edit_full_name" class="block text-sm font-medium text-gray-700">Full Name</label>
                  <input type="text" id="edit_full_name" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md">
              </div>
               <div>
                  <label class="block text-sm font-medium text-gray-700">Gender</label>
                  <div class="mt-2 flex space-x-6">
                      <div class="flex items-center">
                          <input id="edit_gender_male" name="edit_gender" type="radio" value="Male" required class="h-4 w-4 text-blue-600 border-gray-300">
                          <label for="edit_gender_male" class="ml-2 text-sm text-gray-700">Male</label>
                      </div>
                      <div class="flex items-center">
                          <input id="edit_gender_female" name="edit_gender" type="radio" value="Female" class="h-4 w-4 text-blue-600 border-gray-300">
                          <label for="edit_gender_female" class="ml-2 text-sm text-gray-700">Female</label>
                      </div>
                  </div>
              </div>
              <div>
                  <label for="edit_age" class="block text-sm font-medium text-gray-700">Age</label>
                  <input type="number" id="edit_age" min="1" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md">
              </div>
              <div>
                  <label for="edit_school_club" class="block text-sm font-medium text-gray-700">School / Club</label>
                  <input type="text" id="edit_school_club" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md">
              </div>
              
              <!-- Container for editing events -->
              <div id="edit_events_container" class="space-y-2 max-h-60 overflow-y-auto">
                <!-- Dynamic events will be inserted here -->
              </div>

              <div class="flex justify-end space-x-4">
                  <button type="button" id="cancel_update_btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Update Swimmer</button>
              </div>
          </form>
      </div>
  </div>


  <!-- Firebase + App Logic -->
  <script type="module">
    // Updated Firebase imports to a more recent version
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, writeBatch, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCZt6KtFQmU1U8ae7dwa3F4MMtVEY_2AiY",
      authDomain: "swimmingcompetition-91229.firebaseapp.com",
      projectId: "swimmingcompetition-91229",
      storageBucket: "swimmingcompetition-91229.firebasestorage.app",
      messagingSenderId: "1040379968158",
      appId: "1:1040379968158:web:07d232b63116790053598f"
    };

    // Init Firebase
    let app;
    let db;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch (e) {
        console.error("Firebase initialization failed. Please check your firebaseConfig.", e);
        showMessage("Firebase config is invalid. App cannot save data.", "error");
    }
    

    // --- DOM References ---
    const swimmerForm = document.getElementById('swimmer_form');
    const numEventsInput = document.getElementById('num_events');
    const eventsContainer = document.getElementById('events_container');
    const swimmersListContainer = document.getElementById('swimmers_list_container');
    const bulkSubmitBtn = document.getElementById('bulk_submit_btn');
    const addButtonContainer = document.getElementById('add_button_container');
    const editButtonsContainer = document.getElementById('edit_buttons_container');
    const addSwimmerBtn = document.getElementById('add_swimmer_btn');
    const updateSwimmerBtn = document.getElementById('update_swimmer_btn');
    const cancelEditBtn = document.getElementById('cancel_edit_btn');
    const generateDataBtn = document.getElementById('generate_data_btn');
    const genderMaleRadio = document.getElementById('gender_male');
    const genderFemaleRadio = document.getElementById('gender_female');
    const ageInput = document.getElementById('age');
    const ageSeparatorInput = document.getElementById('age_separator');
    // New DOM refs for filter section
    const firebaseSwimmersContainer = document.getElementById('firebase_swimmers_container');
    const searchBox = document.getElementById('search_box');
    const filterSchool = document.getElementById('filter_school');
    const filterAge = document.getElementById('filter_age');
    // New DOM refs for edit modal
    const editModal = document.getElementById('edit_modal');
    const editForm = document.getElementById('edit_form');
    const cancelUpdateBtn = document.getElementById('cancel_update_btn');
    const editEventsContainer = document.getElementById('edit_events_container');
    const editGenderMaleRadio = document.getElementById('edit_gender_male');
    const editGenderFemaleRadio = document.getElementById('edit_gender_female');
    const editAgeInput = document.getElementById('edit_age');


    // --- Data Storage ---
    let allSwimmersData = []; // For local list before submission
    let firebaseSwimmers = []; // To hold the live data from Firebase
    let editingSwimmerId = null;

    // --- Event Listeners ---
    numEventsInput.addEventListener('input', generateEventCheckboxes);
    addSwimmerBtn.addEventListener('click', handleAddSwimmer);
    updateSwimmerBtn.addEventListener('click', handleUpdateSwimmer);
    cancelEditBtn.addEventListener('click', cancelEditMode);
    bulkSubmitBtn.addEventListener('click', handleBulkSubmit);
    generateDataBtn.addEventListener('click', handleGenerateSampleData);
    genderMaleRadio.addEventListener('change', generateEventCheckboxes);
    genderFemaleRadio.addEventListener('change', generateEventCheckboxes);
    ageInput.addEventListener('input', generateEventCheckboxes);
    ageSeparatorInput.addEventListener('input', generateEventCheckboxes);
    // New event listeners for filters
    searchBox.addEventListener('input', () => renderFirebaseSwimmers());
    filterSchool.addEventListener('input', () => renderFirebaseSwimmers());
    filterAge.addEventListener('input', () => renderFirebaseSwimmers());
    // New event listeners for edit modal
    cancelUpdateBtn.addEventListener('click', () => editModal.classList.add('hidden'));
    editForm.addEventListener('submit', handleUpdateFirebaseSwimmer);
    editGenderMaleRadio.addEventListener('change', populateEditModalEvents);
    editGenderFemaleRadio.addEventListener('change', populateEditModalEvents);
    editAgeInput.addEventListener('input', populateEditModalEvents);


    // --- Functions ---
    
    /**
     * Dynamically creates checkboxes for events based on number, gender, and age.
     */
    function generateEventCheckboxes() {
      eventsContainer.innerHTML = '';
      const numberOfEvents = parseInt(numEventsInput.value, 10);
      const selectedGender = document.querySelector('input[name="gender"]:checked')?.value;
      const swimmerAge = parseInt(ageInput.value, 10);
      const ageSeparator = parseInt(ageSeparatorInput.value, 10);

      if (isNaN(numberOfEvents) || numberOfEvents <= 0) {
          return;
      }
      
      if (!selectedGender || isNaN(swimmerAge)) {
          const message = document.createElement('p');
          message.textContent = 'Please select a gender and enter an age to see available events.';
          message.className = 'text-sm text-gray-500 italic';
          eventsContainer.appendChild(message);
          return;
      }

      const mainLabel = document.createElement('label');
      mainLabel.textContent = 'Select Events & Enter Seed Times';
      mainLabel.className = 'block text-sm font-medium text-gray-700';
      eventsContainer.appendChild(mainLabel);

      let eventCount = 0;
      for (let i = 1; i <= numberOfEvents; i++) {
        let shouldShow = true;

        if (selectedGender === 'Male' && i % 2 === 0) shouldShow = false;
        if (selectedGender === 'Female' && i % 2 !== 0) shouldShow = false;

        if (shouldShow && !isNaN(swimmerAge) && !isNaN(ageSeparator)) {
            if (swimmerAge <= ageSeparator) {
                if (i % 4 === 3 || i % 4 === 0) shouldShow = false;
            } else {
                if (i % 4 === 1 || i % 4 === 2) shouldShow = false;
            }
        }

        if (!shouldShow) continue;
        
        eventCount++;

        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center space-x-4';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `event_${i}`;
        checkbox.name = 'events';
        checkbox.value = `Event ${i}`;
        checkbox.className = 'h-4 w-4 text-blue-600 border-gray-300 rounded';

        const label = document.createElement('label');
        label.htmlFor = `event_${i}`;
        label.textContent = `Event ${i}`;
        label.className = 'ml-2 text-sm text-gray-700 w-20 flex-shrink-0';

        const seedTimeInput = document.createElement('input');
        seedTimeInput.type = 'text';
        seedTimeInput.id = `seed_time_${i}`;
        seedTimeInput.placeholder = 'e.g., 01:23.45';
        seedTimeInput.className = 'hidden w-full px-3 py-1 text-sm border border-gray-300 rounded-md';

        checkbox.addEventListener('change', e => {
          seedTimeInput.classList.toggle('hidden', !e.target.checked);
          if (!e.target.checked) seedTimeInput.value = '';
        });

        seedTimeInput.addEventListener('input', e => {
          e.target.value = e.target.value.replace(/-/g, ':').replace(/[^0-9:]/g, '');
        });

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        wrapper.appendChild(seedTimeInput);
        eventsContainer.appendChild(wrapper);
      }
      
      if (eventCount === 0) {
          const noEventsLabel = document.createElement('p');
          noEventsLabel.textContent = `No available events for the selected criteria.`;
          noEventsLabel.className = 'text-sm text-gray-500';
          eventsContainer.appendChild(noEventsLabel);
      }
    }


    /**
     * Resets the input form fields to their default state, retaining some values.
     */
    function resetPartialForm() {
      document.getElementById('full_name').value = '';
      document.getElementById('age').value = '';
      genderMaleRadio.checked = false;
      genderFemaleRadio.checked = false;
      eventsContainer.innerHTML = '';
      document.getElementById('full_name').focus();
    }

    /**
     * Gathers all the data from the form fields and returns it as an object.
     * @returns {object|null} The swimmer data object or null if validation fails.
     */
    function getSwimmerDataFromForm() {
      if (!swimmerForm.checkValidity()) {
        swimmerForm.reportValidity();
        return null;
      }
      const formData = new FormData(swimmerForm);
      const selectedEvents = [];
      document.querySelectorAll('input[name="events"]:checked').forEach(cb => {
        const num = cb.id.split('_')[1];
        const time = document.getElementById(`seed_time_${num}`).value;
        selectedEvents.push({ name: cb.value, time: time || 'NT' });
      });
      return {
        fullName: formData.get('full_name'),
        gender: formData.get('gender'),
        age: formData.get('age'),
        schoolClub: formData.get('school_club'),
        events: selectedEvents
      };
    }

    /**
     * Handles the "Add Swimmer" button click.
     */
    function handleAddSwimmer() {
      const data = getSwimmerDataFromForm();
      if (!data) return;
      allSwimmersData.push({ id: Date.now(), ...data });
      renderSwimmersList();
      resetPartialForm();
    }
    
    /**
     * Renders the list of added swimmers into a table.
     */
    function renderSwimmersList() {
      swimmersListContainer.innerHTML = '';
      if (allSwimmersData.length === 0) {
        bulkSubmitBtn.classList.add('hidden');
        return;
      }
      const listHeader = document.createElement('h2');
      listHeader.textContent = 'Added Swimmers';
      listHeader.className = 'text-xl font-semibold text-gray-700 mb-2';
      swimmersListContainer.appendChild(listHeader);

      const table = document.createElement('table');
      table.className = 'min-w-full divide-y divide-gray-200 bg-white shadow rounded-lg';
      table.innerHTML = `
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name & Club</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Events & Times</th>
            <th class="relative px-4 py-3"><span class="sr-only">Actions</span></th>
          </tr>
        </thead>
      `;
      const tbody = document.createElement('tbody');
      tbody.className = "bg-white divide-y divide-gray-200";

      allSwimmersData.forEach(swimmer => {
        const tr = document.createElement('tr');
        const eventsHtml = swimmer.events.length
          ? swimmer.events.map(e => `${e.name} (${e.time || 'N/A'})`).join('<br>')
          : 'No events';
        tr.innerHTML = `
          <td class="px-4 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${swimmer.fullName}</div><div class="text-sm text-gray-500">${swimmer.schoolClub}</div></td>
          <td class="px-4 py-4 whitespace-nowrap"><div class="text-sm text-gray-900">Age: ${swimmer.age}</div><div class="text-sm text-gray-500">${swimmer.gender}</div></td>
          <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${eventsHtml}</td>
          <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
            <button onclick="handleEditSwimmer(${swimmer.id})" class="text-indigo-600 hover:text-indigo-900">Edit</button>
            <button onclick="removeSwimmer(${swimmer.id})" class="text-red-600 hover:text-red-900">Remove</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      swimmersListContainer.appendChild(table);

      bulkSubmitBtn.classList.remove('hidden');
    }

    /**
     * Populates the form with a swimmer's data for editing.
     * @param {number} id - The unique ID of the swimmer to edit.
     */
    window.handleEditSwimmer = function (id) {
      const swimmer = allSwimmersData.find(s => s.id === id);
      if (!swimmer) return;
      
      editingSwimmerId = id;
      document.getElementById('full_name').value = swimmer.fullName;
      document.getElementById('age').value = swimmer.age;
      document.getElementById('school_club').value = swimmer.schoolClub;
      document.querySelector(`input[name="gender"][value="${swimmer.gender}"]`).checked = true;

      const eventCount = Math.max(
        swimmer.events.length, 
        ...swimmer.events.map(e => parseInt(e.name.split(' ')[1]))
      );
      numEventsInput.value = isNaN(eventCount) ? 0 : eventCount;
      generateEventCheckboxes();

      swimmer.events.forEach(event => {
        const cb = document.querySelector(`input[value="${event.name}"]`);
        if (cb) {
          cb.checked = true;
          const num = cb.id.split('_')[1];
          const input = document.getElementById(`seed_time_${num}`);
          input.value = event.time;
          input.classList.remove('hidden');
        }
      });

      setEditMode(true);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    /**
     * Handles the "Update Swimmer" button click.
     */
    function handleUpdateSwimmer() {
      const data = getSwimmerDataFromForm();
      if (!data || editingSwimmerId === null) return;
      const idx = allSwimmersData.findIndex(s => s.id === editingSwimmerId);
      if (idx > -1) {
        allSwimmersData[idx] = { id: editingSwimmerId, ...data };
      }
      renderSwimmersList();
      resetPartialForm();
      setEditMode(false);
    }

    /**
     * Cancels the edit mode and resets the form.
     */
    function cancelEditMode() {
      resetPartialForm();
      setEditMode(false);
    }

    /**
     * Removes a swimmer from the local array.
     * @param {number} id - The unique ID of the swimmer to remove.
     */
    window.removeSwimmer = function (id) {
      if (editingSwimmerId === id) cancelEditMode();
      allSwimmersData = allSwimmersData.filter(s => s.id !== id);
      renderSwimmersList();
    };

    /**
     * Generates 30 sample swimmer records based on current filter criteria.
     */
    function handleGenerateSampleData() {
        const sampleNames = ["Alex Johnson", "Bella Smith", "Charlie Brown", "Diana Prince", "Ethan Hunt", "Fiona Glenanne", "George Kirk", "Hannah Montana", "Ian Malcolm", "Jane Doe", "Kyle Reese", "Lara Croft", "Max Rockatansky", "Nina Williams", "Oscar Goldman", "Penny Parker", "Quinn Fabray", "Rachel Green", "Steve Rogers", "Tony Stark", "Uma Thurman", "Vito Corleone", "Walter White", "Xena Warrior", "Yoda", "Zoe Washburne", "John Wick", "Peter Pan", "Clark Kent", "Bruce Wayne"];
        const sampleClubs = ["Dolphins Swim Team", "Aqua Racers", "Sea Dragons", "Wave Runners", "Blue Marlins"];
        const ageSeparator = parseInt(ageSeparatorInput.value, 10);
        const maxEvents = parseInt(numEventsInput.value, 10) || 24;

        if (isNaN(ageSeparator)) {
            showMessage("Please enter a valid Age Separator value.", "error");
            return;
        }
        
        const generatedSwimmers = [];
        for (let i = 0; i < 30; i++) {
            const swimmerGender = Math.random() > 0.5 ? 'Male' : 'Female';
            const swimmerAge = Math.floor(Math.random() * 12) + 6;

            const eligibleEvents = [];
            for (let eventNum = 1; eventNum <= maxEvents; eventNum++) {
                let isEligible = true;

                if (swimmerGender === 'Male' && eventNum % 2 === 0) isEligible = false;
                if (swimmerGender === 'Female' && eventNum % 2 !== 0) isEligible = false;

                if (isEligible) {
                    if (swimmerAge <= ageSeparator) {
                        if (eventNum % 4 === 3 || eventNum % 4 === 0) isEligible = false;
                    } else {
                        if (eventNum % 4 === 1 || eventNum % 4 === 2) isEligible = false;
                    }
                }
                
                if (isEligible) {
                    eligibleEvents.push(eventNum);
                }
            }

            const selectedEvents = [];
            const eventsToSelect = Math.min(eligibleEvents.length, 5);
            
            const shuffledEligible = eligibleEvents.sort(() => 0.5 - Math.random());
            for(let k = 0; k < eventsToSelect; k++) {
                const eventNum = shuffledEligible[k];
                const minutes = Math.floor(Math.random() * 2) + 1;
                const seconds = Math.floor(Math.random() * 60);
                const milliseconds = Math.floor(Math.random() * 100);
                const formattedTime = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(2, '0')}`;
                selectedEvents.push({ name: `Event ${eventNum}`, time: formattedTime });
            }

            generatedSwimmers.push({
                id: Date.now() + i,
                fullName: sampleNames[i % sampleNames.length],
                gender: swimmerGender,
                age: swimmerAge,
                schoolClub: sampleClubs[i % sampleClubs.length],
                events: selectedEvents
            });
        }
        
        allSwimmersData = allSwimmersData.concat(generatedSwimmers);
        renderSwimmersList();
        showMessage(`🎉 Generated 30 sample swimmers based on current filters!`, 'success');
    }

    /**
     * Handles the "Bulk Submit" button click, saving data to Firestore.
     */
    async function handleBulkSubmit() {
      if (allSwimmersData.length === 0) return;
      if (!db) {
          showMessage("Firebase is not configured correctly. Cannot submit.", "error");
          return;
      }
      
      bulkSubmitBtn.disabled = true;
      bulkSubmitBtn.textContent = 'Submitting...';

      try {
        const swimmersCollection = collection(db, "swimmers");
        const batch = writeBatch(db);
        allSwimmersData.forEach(swimmer => {
            const { id, ...firebaseData } = swimmer;
            const newSwimmerRef = doc(swimmersCollection);
            batch.set(newSwimmerRef, firebaseData);
        });

        await batch.commit();
        
        showMessage(`✅ Submitted ${allSwimmersData.length} swimmer(s) to Firebase!`, 'success');
        allSwimmersData = [];
        editingSwimmerId = null;
        renderSwimmersList();
        resetPartialForm();
        setEditMode(false);
      } catch (err) {
        console.error("Error saving swimmers to Firebase: ", err);
        showMessage(`❌ Error: ${err.message}`, 'error');
      } finally {
        bulkSubmitBtn.disabled = false;
        bulkSubmitBtn.textContent = 'Bulk Submit All Swimmers';
      }
    }

    /**
     * Displays a temporary message box at the top of the screen.
     * @param {string} text - The message to display.
     * @param {'success'|'error'} type - The type of message, for styling.
     */
    function showMessage(text, type = 'success') {
        const box = document.createElement('div');
        box.textContent = text;
        const baseStyles = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; font-size: 1rem;';
        const typeStyles = type === 'success' 
            ? 'background-color: #28a745;' 
            : 'background-color: #dc3545;';
        box.style.cssText = baseStyles + typeStyles;
        
        document.body.appendChild(box);
        setTimeout(() => {
            box.style.transition = 'opacity 0.5s ease';
            box.style.opacity = '0';
            setTimeout(() => box.remove(), 500);
        }, 4000);
    }

    // --- NEW Functions for Firebase Data Viewer ---

    /**
     * Listens for real-time updates from the 'swimmers' collection in Firebase.
     */
    function listenForSwimmers() {
        if (!db) return;
        const swimmersCollection = collection(db, 'swimmers');
        onSnapshot(swimmersCollection, (snapshot) => {
            firebaseSwimmers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderFirebaseSwimmers();
        }, (error) => {
            console.error("Error listening to swimmers collection:", error);
            firebaseSwimmersContainer.innerHTML = `<p class="text-center text-red-500">Error loading swimmers.</p>`;
        });
    }

    /**
     * Renders the list of swimmers from Firebase, applying any active filters.
     */
    function renderFirebaseSwimmers() {
        firebaseSwimmersContainer.innerHTML = '';
        
        const searchTerm = searchBox.value.toLowerCase();
        const schoolFilter = filterSchool.value.toLowerCase();
        const ageFilter = filterAge.value;

        const filteredData = firebaseSwimmers.filter(swimmer => {
            const nameMatch = swimmer.fullName.toLowerCase().includes(searchTerm);
            const schoolMatch = swimmer.schoolClub.toLowerCase().includes(schoolFilter);
            const ageMatch = !ageFilter || swimmer.age == ageFilter;
            return nameMatch && schoolMatch && ageMatch;
        });

        if (filteredData.length === 0) {
            firebaseSwimmersContainer.innerHTML = `<p class="text-center text-gray-500">No swimmers found matching the criteria.</p>`;
            return;
        }

        filteredData.forEach(swimmer => {
            const eventsHtml = swimmer.events && swimmer.events.length
                ? swimmer.events.map(e => `${e.name} (${e.time || 'N/A'})`).join(', ')
                : 'No events';

            const card = document.createElement('div');
            card.className = 'p-4 border rounded-lg bg-gray-50 grid grid-cols-1 md:grid-cols-4 gap-4 items-center';
            card.innerHTML = `
                <div>
                    <p class="font-bold text-gray-800">${swimmer.fullName}</p>
                    <p class="text-sm text-gray-600">${swimmer.schoolClub}</p>
                </div>
                <div>
                    <p class="text-sm"><span class="font-medium">Age:</span> ${swimmer.age}</p>
                    <p class="text-sm"><span class="font-medium">Gender:</span> ${swimmer.gender}</p>
                </div>
                <div class="md:col-span-1">
                    <p class="text-sm text-gray-600">${eventsHtml}</p>
                </div>
                <div class="flex justify-end space-x-2">
                    <button data-id="${swimmer.id}" class="edit-fb-btn px-3 py-1 bg-yellow-500 text-white text-sm rounded-md hover:bg-yellow-600">Edit</button>
                    <button data-id="${swimmer.id}" class="delete-fb-btn px-3 py-1 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">Delete</button>
                </div>
            `;
            firebaseSwimmersContainer.appendChild(card);
        });
    }

    /**
     * Handles clicks on the edit and delete buttons for Firebase data.
     */
    firebaseSwimmersContainer.addEventListener('click', (e) => {
        const target = e.target;
        const docId = target.dataset.id;
        if (!docId) return;

        if (target.classList.contains('edit-fb-btn')) {
            const swimmer = firebaseSwimmers.find(s => s.id === docId);
            if (swimmer) {
                openEditModal(swimmer);
            }
        }

        if (target.classList.contains('delete-fb-btn')) {
            if (confirm('Are you sure you want to delete this swimmer?')) {
                handleDeleteFirebaseSwimmer(docId);
            }
        }
    });

    /**
     * Opens and populates the edit modal with the swimmer's data.
     */
    function openEditModal(swimmer) {
        document.getElementById('edit_doc_id').value = swimmer.id;
        document.getElementById('edit_full_name').value = swimmer.fullName;
        document.getElementById('edit_age').value = swimmer.age;
        document.getElementById('edit_school_club').value = swimmer.schoolClub;
        
        if (swimmer.gender === 'Male') {
            editGenderMaleRadio.checked = true;
        } else {
            editGenderFemaleRadio.checked = true;
        }
        
        populateEditModalEvents();
        editModal.classList.remove('hidden');
    }

    /**
     * Populates the event checkboxes inside the edit modal based on the swimmer's info.
     */
    function populateEditModalEvents() {
        const docId = document.getElementById('edit_doc_id').value;
        const swimmer = firebaseSwimmers.find(s => s.id === docId);
        if (!swimmer) return;

        const swimmerAge = parseInt(editAgeInput.value, 10);
        const selectedGender = document.querySelector('input[name="edit_gender"]:checked')?.value;
        
        editEventsContainer.innerHTML = '';
        const ageSeparator = parseInt(ageSeparatorInput.value, 10);
        const maxEvents = parseInt(numEventsInput.value, 10) || 24;

        for (let i = 1; i <= maxEvents; i++) {
            let isEligible = true;
            if (selectedGender === 'Male' && i % 2 === 0) isEligible = false;
            if (selectedGender === 'Female' && i % 2 !== 0) isEligible = false;
            
            if (isEligible) {
                if (swimmerAge <= ageSeparator) {
                    if (i % 4 === 3 || i % 4 === 0) isEligible = false;
                } else {
                    if (i % 4 === 1 || i % 4 === 2) isEligible = false;
                }
            }
            if (!isEligible) continue;

            const existingEvent = swimmer.events.find(e => e.name === `Event ${i}`);
            
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center space-x-4';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `edit_event_${i}`;
            checkbox.name = 'edit_events';
            checkbox.value = `Event ${i}`;
            checkbox.checked = !!existingEvent;
            checkbox.className = 'h-4 w-4 text-blue-600 border-gray-300 rounded';

            const label = document.createElement('label');
            label.htmlFor = `edit_event_${i}`;
            label.textContent = `Event ${i}`;
            label.className = 'ml-2 text-sm text-gray-700 w-20 flex-shrink-0';

            const seedTimeInput = document.createElement('input');
            seedTimeInput.type = 'text';
            seedTimeInput.id = `edit_seed_time_${i}`;
            seedTimeInput.value = existingEvent ? existingEvent.time : '';
            seedTimeInput.placeholder = 'e.g., 01:23.45';
            seedTimeInput.className = `w-full px-3 py-1 text-sm border border-gray-300 rounded-md ${!existingEvent ? 'hidden' : ''}`;
            
            checkbox.addEventListener('change', e => {
              seedTimeInput.classList.toggle('hidden', !e.target.checked);
              if (!e.target.checked) seedTimeInput.value = '';
            });

            seedTimeInput.addEventListener('input', e => {
              e.target.value = e.target.value.replace(/-/g, ':').replace(/[^0-9:]/g, '');
            });

            wrapper.appendChild(checkbox);
            wrapper.appendChild(label);
            wrapper.appendChild(seedTimeInput);
            editEventsContainer.appendChild(wrapper);
        }
    }

    /**
     * Handles the submission of the edit form to update a swimmer in Firebase.
     */
    async function handleUpdateFirebaseSwimmer(e) {
        e.preventDefault();
        const docId = document.getElementById('edit_doc_id').value;
        
        const updatedEvents = [];
        document.querySelectorAll('input[name="edit_events"]:checked').forEach(cb => {
            const num = cb.id.split('_')[2];
            const time = document.getElementById(`edit_seed_time_${num}`).value;
            updatedEvents.push({ name: cb.value, time: time || 'NT' });
        });

        const updatedData = {
            fullName: document.getElementById('edit_full_name').value,
            age: document.getElementById('edit_age').value,
            schoolClub: document.getElementById('edit_school_club').value,
            gender: document.querySelector('input[name="edit_gender"]:checked').value,
            events: updatedEvents
        };

        if (!docId || !db) return;

        const swimmerRef = doc(db, 'swimmers', docId);
        try {
            await updateDoc(swimmerRef, updatedData);
            showMessage('✅ Swimmer updated successfully!', 'success');
            editModal.classList.add('hidden');
        } catch (error) {
            console.error("Error updating document: ", error);
            showMessage('❌ Error updating swimmer.', 'error');
        }
    }

    /**
     * Deletes a swimmer document from Firebase.
     */
    async function handleDeleteFirebaseSwimmer(docId) {
        if (!docId || !db) return;
        const swimmerRef = doc(db, 'swimmers', docId);
        try {
            await deleteDoc(swimmerRef);
            showMessage('✅ Swimmer deleted successfully!', 'success');
        } catch (error) {
            console.error("Error deleting document: ", error);
            showMessage('❌ Error deleting swimmer.', 'error');
        }
    }


    // Initial call to load data from Firebase when the page loads
    listenForSwimmers();
    
  </script>
</body>
</html>
