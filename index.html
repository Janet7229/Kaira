<!DOCTYPE html>
<html>
<head>
  <title>Firebase Image Upload with Comment</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .post { margin-top: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 8px; }
    img { max-width: 200px; border-radius: 4px; }
  </style>
</head>
<body>

<h2>Upload Photo with Comment</h2>
<input type="file" id="imageInput" accept="image/*"><br><br>
<textarea id="commentInput" placeholder="Enter your comment" rows="3" cols="40"></textarea><br><br>
<button onclick="uploadPost()">Upload</button>

<h3>All Posts</h3>
<div id="postsContainer"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
    authDomain: "shamankingdata.firebaseapp.com",
    projectId: "shamankingdata",
    storageBucket: "shamankingdata.appspot.com",
    messagingSenderId: "757444066890",
    appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);
  const db = getFirestore(app);
  const auth = getAuth(app);

  signInAnonymously(auth);

  async function uploadPost() {
    const fileInput = document.getElementById("imageInput");
    const comment = document.getElementById("commentInput").value.trim();

    if (!fileInput.files[0] || !comment) {
      alert("Please select an image and write a comment.");
      return;
    }

    const file = fileInput.files[0];

    // Convert to WebP
    const webpBlob = await convertToWebP(file);

    const storageRef = ref(storage, 'images/' + Date.now() + '.webp');
    await uploadBytes(storageRef, webpBlob);
    const imageUrl = await getDownloadURL(storageRef);

    await addDoc(collection(db, "posts"), {
      comment: comment,
      imageUrl: imageUrl,
      timestamp: serverTimestamp()
    });

    alert("Uploaded successfully!");
    fileInput.value = '';
    document.getElementById("commentInput").value = '';
    loadPosts();
  }

  async function convertToWebP(file) {
    return new Promise((resolve) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = (e) => {
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          canvas.toBlob((blob) => {
            resolve(blob);
          }, "image/webp", 0.8);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  }

  async function loadPosts() {
    const container = document.getElementById("postsContainer");
    container.innerHTML = "";
    const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
    const snapshot = await getDocs(q);
    snapshot.forEach(doc => {
      const data = doc.data();
      const div = document.createElement("div");
      div.className = "post";
      div.innerHTML = `
        <img src="${data.imageUrl}" alt="uploaded image"><br>
        <strong>Comment:</strong><br>${data.comment}
      `;
      container.appendChild(div);
    });
  }

  loadPosts();
</script>

</body>
</html>
