<!DOCTYPE html>
<html>
<head>
  <title>Post with Replies</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>
    .post { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
    .replies { margin-left: 20px; }
  </style>
</head>
<body>

  <h2>Upload a Post</h2>
  <input type="file" id="postFile">
  <button onclick="uploadPost()">Upload Post</button>

  <h2>Posts</h2>
  <div id="postList"></div>

  <script>
    // ✅ Your Firebase config here
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // ✅ Anonymous sign-in to satisfy storage rules
    firebase.auth().signInAnonymously().catch(console.error);

    function uploadPost() {
      const file = document.getElementById('postFile').files[0];
      if (!file) return alert("Select a file first.");
      const timestamp = Date.now();
      const ref = storage.ref(`images/${timestamp}.webp`);
      ref.put(file).then(() => {
        ref.getDownloadURL().then(url => {
          addPostToPage(url, timestamp);
        });
      });
    }

    function addPostToPage(url, postId) {
      const postDiv = document.createElement('div');
      postDiv.className = 'post';
      postDiv.innerHTML = `
        <img src="${url}" width="200"><br>
        <input type="file" id="replyFile-${postId}">
        <button onclick="uploadReply('${postId}')">Reply</button>
        <div class="replies" id="replies-${postId}"></div>
      `;
      document.getElementById('postList').prepend(postDiv);
    }

    function uploadReply(postId) {
      const fileInput = document.getElementById(`replyFile-${postId}`);
      const file = fileInput.files[0];
      if (!file) return alert("Select a reply image.");
      const timestamp = Date.now();
      const replyRef = storage.ref(`replies/${postId}/${timestamp}.webp`);
      replyRef.put(file).then(() => {
        replyRef.getDownloadURL().then(url => {
          const replyImg = document.createElement('img');
          replyImg.src = url;
          replyImg.width = 100;
          document.getElementById(`replies-${postId}`).appendChild(replyImg);
        });
      });
    }
  </script>

</body>
</html>
