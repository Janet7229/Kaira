<!DOCTYPE html>
<html>
<head>
  <title>Upload Your Photo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.3/simple-lightbox.min.css" />
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
      margin: 0;
    }
    .logo-container {
      text-align: center;
      margin-bottom: 20px;
    }
    .logo-container img {
      max-width: 100%;
      height: auto;
      max-height: 150px;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, textarea, button {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    h2, h3 {
      color: #333;
    }
    .post {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 8px;
    }
    .post img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin-top: 10px;
      cursor: pointer;
    }
    #receipt {
      margin-top: 20px;
      padding: 15px;
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
      display: none;
      text-align: center;
    }
    .admin-reply-container {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .reply-button {
      background-color: #28a745;
    }
    .reply-button:hover {
      background-color: #218838;
    }
    #logoutButton {
      background-color: #dc3545;
    }
    #loginError {
      color: #dc3545;
      margin-top: 10px;
      text-align: center;
    }
    @media (max-width: 600px) {
      body { padding: 10px; }
      .container { padding: 15px; }
      h2 { font-size: 1.5em; }
      h3 { font-size: 1.2em; }
    }
  </style>
</head>
<body>

<div class="logo-container">
  <img src="RInew(1).jpg" alt="Logo">
</div>

<div id="login-container" class="container">
  <h2>Admin Login</h2>
  <input type="email" id="emailInput" placeholder="Email">
  <input type="password" id="passwordInput" placeholder="Password">
  <button id="loginButton">Login</button>
  <div id="loginError"></div>
</div>

<div id="main-content" class="container" style="display: none;">
  <button id="logoutButton">Logout</button>
  <hr style="margin-top:20px; margin-bottom: 20px;">
  
  <h2>Upload Photo with Comment</h2>
  <input type="file" id="imageInput" accept="image/*"><br>
  <textarea id="commentInput" placeholder="Enter your comment" rows="4"></textarea><br>
  <button id="uploadButton">Upload</button>
  <div id="receipt"></div>

  <h3>Approved Posts</h3>
  <div id="postsContainer">Loading...</div>
</div>

<script type="module">
  // --- Import necessary Firebase modules ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
  import { getFirestore, collection, getDocs, query, where, orderBy, serverTimestamp, runTransaction, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // --- Firebase Configuration ---
  const firebaseConfig = {
    apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
    authDomain: "shamankingdata.firebaseapp.com",
    projectId: "shamankingdata",
    storageBucket: "shamankingdata.appspot.com",
    messagingSenderId: "757444066890",
    appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
  };

  // --- Initialize Firebase ---
  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  // --- DOM Element References ---
  const loginContainer = document.getElementById('login-container');
  const mainContent = document.getElementById('main-content');
  const loginButton = document.getElementById('loginButton');
  const logoutButton = document.getElementById('logoutButton');
  const emailInputElement = document.getElementById('emailInput');
  const passwordInputElement = document.getElementById('passwordInput');
  const loginError = document.getElementById('loginError');
  const uploadButton = document.getElementById("uploadButton");
  const postsContainer = document.getElementById("postsContainer");
  
  let currentUser = null;
  let lightbox = new SimpleLightbox('.post a');

  // --- Authentication State Observer ---
  // This is the main controller for the UI.
  onAuthStateChanged(auth, (user) => {
    if (user && !user.isAnonymous) {
      // User is logged in as an admin
      currentUser = user;
      loginContainer.style.display = 'none';
      mainContent.style.display = 'block';
      loadPosts(); // Load posts with admin controls
    } else {
      // User is logged out or is anonymous
      currentUser = user; // May be null or the anonymous user
      loginContainer.style.display = 'block';
      mainContent.style.display = 'none';
      if (!user) {
        // If completely logged out, sign in anonymously for public view
        signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
      }
    }
  });

  // --- Login/Logout Event Listeners ---
  loginButton.addEventListener('click', async () => {
    const email = emailInputElement.value;
    const password = passwordInputElement.value;
    loginError.textContent = ''; // Clear previous errors

    if (!email || !password) {
      loginError.textContent = 'Please enter both email and password.';
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);
      // onAuthStateChanged will handle the UI switch automatically
    } catch (error) {
      console.error("Login failed:", error.message);
      loginError.textContent = "Login failed. Please check your credentials.";
    }
  });

  logoutButton.addEventListener('click', () => {
    signOut(auth);
    // onAuthStateChanged will handle the UI switch automatically
  });
  
  // --- User Post Upload Function ---
  async function uploadPost() {
    if (!currentUser) {
        alert("Not connected. Please refresh the page.");
        return;
    }
    const fileInput = document.getElementById("imageInput");
    const comment = document.getElementById("commentInput").value.trim();

    if (!fileInput.files[0] || !comment) {
      alert("Please select an image and write a comment.");
      return;
    }
    
    uploadButton.disabled = true;
    uploadButton.textContent = "Uploading...";
    const file = fileInput.files[0];

    try {
      const webpBlob = await convertToWebP(file);
      const storageRef = ref(storage, `images/${Date.now()}.webp`);
      await uploadBytes(storageRef, webpBlob);
      const imageUrl = await getDownloadURL(storageRef);
      const receiptNumber = await runTransaction(db, async (transaction) => {
        const counterRef = doc(db, "counters", "postCounter");
        const counterDoc = await transaction.get(counterRef);
        if (!counterDoc.exists()) throw "Counter document does not exist!";
        const newReceiptNumber = counterDoc.data().count + 1;
        transaction.update(counterRef, { count: newReceiptNumber });
        const newPostRef = doc(collection(db, "posts"));
        transaction.set(newPostRef, {
          comment: comment,
          imageUrl: imageUrl,
          timestamp: serverTimestamp(),
          isVisible: false,
          receiptNumber: newReceiptNumber,
          uploaderId: currentUser.uid
        });
        return newReceiptNumber;
      });
      const receiptDiv = document.getElementById("receipt");
      receiptDiv.innerHTML = `<strong>Upload Successful!</strong><br>Your Receipt Number is: <strong>${receiptNumber}</strong>`;
      receiptDiv.style.display = 'block';
      fileInput.value = '';
      document.getElementById("commentInput").value = '';
    } catch (error) {
      console.error("Upload failed:", error);
      alert("Upload failed. Please check the console for details.");
    } finally {
        uploadButton.disabled = false;
        uploadButton.textContent = "Upload";
    }
  }

  // --- Image to WebP Conversion Utility ---
  function convertToWebP(file) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();
        reader.onload = e => {
            img.onload = () => {
                const canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error("Canvas to Blob failed.")), "image/webp", 0.8);
            };
            img.onerror = () => reject(new Error("Image failed to load."));
            img.src = e.target.result;
        };
        reader.onerror = () => reject(new Error("File reader failed."));
        reader.readAsDataURL(file);
    });
  }
  
  // --- Admin Reply Function ---
  async function handleAdminReply(postId, file) {
    const replyButton = document.querySelector(`button[data-post-id="${postId}"]`);
    if (!replyButton) return;
    replyButton.disabled = true;
    replyButton.textContent = "Replying...";
    try {
        const webpBlob = await convertToWebP(file);
        const storageRef = ref(storage, `admin-replies/${postId}-${Date.now()}.webp`);
        await uploadBytes(storageRef, webpBlob);
        const adminReplyImageUrl = await getDownloadURL(storageRef);
        const postRef = doc(db, "posts", postId);
        await updateDoc(postRef, {
            adminReplyImageUrl: adminReplyImageUrl,
            adminReplyTimestamp: serverTimestamp()
        });
        const adminReplyContainer = document.getElementById(`reply-container-${postId}`);
        adminReplyContainer.innerHTML = `
            <strong>Admin Reply:</strong><br>
            <a href="${adminReplyImageUrl}">
                <img src="${adminReplyImageUrl}" alt="Admin reply image">
            </a>
        `;
        lightbox.refresh();
    } catch (error) {
        console.error("Admin reply failed:", error);
        alert("Admin reply failed. Please check the console.");
        replyButton.disabled = false;
        replyButton.textContent = "Reply with Photo";
    }
  }

  // --- Load and Display Posts Function ---
  async function loadPosts() {
    if (!currentUser) return; // Don't load posts if not authenticated at all
    // Check if the current user is an admin (logged in, not anonymous)
    const isAdmin = currentUser && !currentUser.isAnonymous;
    try {
      const q = query(collection(db, "posts"), where("isVisible", "==", true), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      postsContainer.innerHTML = "";
      if (snapshot.empty) postsContainer.innerHTML = "No approved posts yet.";
      
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const postId = docSnap.id;
        const div = document.createElement("div");
        div.className = "post";
        let adminSection = '';
        if (data.adminReplyImageUrl) {
            adminSection = `<div class="admin-reply-container"><strong>Admin Reply:</strong><br><a href="${data.adminReplyImageUrl}"><img src="${data.adminReplyImageUrl}" alt="Admin reply image"></a></div>`;
        } else if (isAdmin) {
            adminSection = `<div class="admin-reply-container" id="reply-container-${postId}"><input type="file" id="reply-input-${postId}" accept="image/*" style="display: none;"><button class="reply-button" data-post-id="${postId}">Reply with Photo</button></div>`;
        }
        div.innerHTML = `<a href="${data.imageUrl}"><img src="${data.imageUrl}" alt="Uploaded image"></a><br><br><strong>Comment:</strong><br>${data.comment}${adminSection}`;
        postsContainer.appendChild(div);
      });
      lightbox.refresh();
    } catch (error) {
      console.error("Error loading posts:", error);
      postsContainer.innerHTML = "Failed to load posts.";
    }
  }

  // --- Event Listeners for Dynamic Content ---
  document.getElementById('uploadButton').addEventListener('click', uploadPost);
  postsContainer.addEventListener('click', e => {
    if (e.target && e.target.matches('button.reply-button')) {
        const postId = e.target.dataset.postId;
        document.getElementById(`reply-input-${postId}`).click();
    }
  });
  postsContainer.addEventListener('change', e => {
      if (e.target && e.target.matches('input[id^="reply-input-"]')) {
          const file = e.target.files[0];
          const postId = e.target.id.split('-')[2];
          if (file) handleAdminReply(postId, file);
      }
  });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.3/simple-lightbox.min.js"></script>

</body>
</html>
