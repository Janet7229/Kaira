<!DOCTYPE html>
<html>
<head>
  <title>Upload Your Photo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.3/simple-lightbox.min.css" />
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
      margin: 0;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, textarea, button {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1em;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
    }
    h2, h3 {
      color: #333;
    }
    .post {
      margin-top: 20px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
    }
    .post img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
      margin-top: 10px;
      cursor: pointer;
    }
    #receipt, #replyReceipt {
      margin-top: 20px;
      padding: 15px;
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
      display: none;
      text-align: center;
    }
    @media (max-width: 600px) {
      body { padding: 10px; }
      .container { padding: 15px; }
      h2 { font-size: 1.5em; }
      h3 { font-size: 1.2em; }
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Upload Photo with Comment</h2>
  <input type="file" id="imageInput" accept="image/*"><br>
  <textarea id="commentInput" placeholder="Enter your comment" rows="4"></textarea><br>
  <button id="uploadButton">Upload</button>
  <div id="receipt"></div>

  <h3>Approved Posts</h3>
  <div id="postsContainer">Loading...</div>

  <h2>Upload a Reply Photo (No Comment)</h2>
  <input type="file" id="replyImageInput" accept="image/*"><br>
  <button id="replyUploadButton">Upload Reply</button>
  <div id="replyReceipt"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
  import { getFirestore, collection, getDocs, query, where, orderBy, serverTimestamp, runTransaction, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
    authDomain: "shamankingdata.firebaseapp.com",
    projectId: "shamankingdata",
    storageBucket: "shamankingdata.appspot.com", // ✅ FIXED
    messagingSenderId: "757444066890",
    appId: "1:757444066890:web:e4f9d41e2905e588d930b3",
    measurementId: "G-DD8SFH6MYD"
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;
  signInAnonymously(auth).then(result => {
    currentUser = result.user;
  }).catch(error => {
    console.error("Sign-in failed:", error);
    alert("Failed to connect. Refresh the page.");
  });

  document.getElementById('uploadButton').addEventListener('click', uploadPost);
  document.getElementById('replyUploadButton').addEventListener('click', uploadReply);

  async function uploadPost() {
    if (!currentUser) return alert("Not connected.");

    const file = document.getElementById("imageInput").files[0];
    const comment = document.getElementById("commentInput").value.trim();
    if (!file || !comment) return alert("Select an image and add a comment.");

    const button = document.getElementById("uploadButton");
    button.disabled = true;
    button.textContent = "Uploading...";

    try {
      const webp = await convertToWebP(file);
      const storageRef = ref(storage, `images/${Date.now()}.webp`);
      await uploadBytes(storageRef, webp);
      const url = await getDownloadURL(storageRef);

      const receipt = await runTransaction(db, async transaction => {
        const counterRef = doc(db, "counters", "postCounter");
        const counterDoc = await transaction.get(counterRef);
        const newCount = (counterDoc.exists() ? counterDoc.data().count : 0) + 1;
        transaction.set(counterRef, { count: newCount }, { merge: true });
        transaction.set(doc(collection(db, "posts")), {
          comment, imageUrl: url, timestamp: serverTimestamp(),
          isVisible: false, receiptNumber: newCount, uploaderId: currentUser.uid
        });
        return newCount;
      });

      document.getElementById("receipt").innerHTML = `✅ Upload Successful!<br>Receipt #: <strong>${receipt}</strong>`;
      document.getElementById("receipt").style.display = "block";
      document.getElementById("imageInput").value = '';
      document.getElementById("commentInput").value = '';
    } catch (e) {
      console.error("Upload failed:", e);
      alert("Upload failed.");
    } finally {
      button.disabled = false;
      button.textContent = "Upload";
    }
  }

  async function uploadReply() {
    if (!currentUser) return alert("Not connected.");
    const file = document.getElementById("replyImageInput").files[0];
    if (!file) return alert("Select an image to upload.");

    const button = document.getElementById("replyUploadButton");
    button.disabled = true;
    button.textContent = "Uploading...";

    try {
      const webp = await convertToWebP(file);
      const storageRef = ref(storage, `replies/${Date.now()}.webp`);
      await uploadBytes(storageRef, webp);
      const url = await getDownloadURL(storageRef);

      await runTransaction(db, async transaction => {
        const counterRef = doc(db, "counters", "replyCounter");
        const counterDoc = await transaction.get(counterRef);
        const newCount = (counterDoc.exists() ? counterDoc.data().count : 0) + 1;
        transaction.set(counterRef, { count: newCount }, { merge: true });
        transaction.set(doc(collection(db, "replies")), {
          imageUrl: url, timestamp: serverTimestamp(), uploaderId: currentUser.uid
        });
      });

      document.getElementById("replyReceipt").innerHTML = `✅ Reply Uploaded Successfully!`;
      document.getElementById("replyReceipt").style.display = "block";
      document.getElementById("replyImageInput").value = '';
    } catch (e) {
      console.error("Reply upload failed:", e);
      alert("Upload failed.");
    } finally {
      button.disabled = false;
      button.textContent = "Upload Reply";
    }
  }

  function convertToWebP(file) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => {
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          canvas.toBlob(blob => blob ? resolve(blob) : reject("Blob conversion failed."), "image/webp", 0.8);
        };
        img.onerror = () => reject("Image load error");
        img.src = e.target.result;
      };
      reader.onerror = () => reject("FileReader error");
      reader.readAsDataURL(file);
    });
  }

  async function loadPosts() {
    const container = document.getElementById("postsContainer");
    try {
      const q = query(collection(db, "posts"), where("isVisible", "==", true), orderBy("timestamp", "desc"));
      const snapshot = await getDocs(q);
      container.innerHTML = "";
      if (snapshot.empty) {
        container.innerHTML = "No approved posts yet.";
      }
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <a href="${data.imageUrl}">
            <img src="${data.imageUrl}" alt="Uploaded image">
          </a><br><strong>Comment:</strong><br>${data.comment}
        `;
        container.appendChild(div);
      });
      new SimpleLightbox('.post a');
    } catch (e) {
      console.error("Loading posts failed:", e);
      container.innerHTML = "Failed to load posts.";
    }
  }

  loadPosts();
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.3/simple-lightbox.min.js"></script>
</body>
</html>
